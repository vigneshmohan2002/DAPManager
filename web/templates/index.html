<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAP Manager Web</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #222;
            padding: 20px;
            border: 1px solid #555;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            color: #fff;
            margin: 100px auto;
            /* Fallback centering */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>DAP Manager Dashboard</h1>
            <div id="status-bar" class="status-idle">Status: Idle</div>
        </header>

        <main>
            <section class="card">
                <h2>Library Management</h2>
                <div class="actions">
                    <button onclick="triggerAction('/api/scan', 'Scanning Library...')">Scan Library</button>
                    <button onclick="triggerAction('/api/audit', 'Auditing Albums...')">Audit Albums</button>
                </div>

                <div style="margin-top: 15px;">
                    <h3>Queue Spotify Playlists</h3>
                    <textarea id="playlist-urls" rows="3"
                        placeholder="Paste Spotify Playlist URLs here (one per line)..."
                        style="width: 100%; background: #333; color: white; border: 1px solid #555; padding: 5px;"></textarea>
                    <button onclick="queuePlaylists()" style="margin-top: 5px;">Queue Playlists</button>
                </div>

                <div style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                    <h3>Library Audit</h3>
                    <button onclick="loadAuditResults()">Scan for Incomplete Albums</button>
                    <div id="audit-container" style="margin-top: 10px; display: none;">
                        <p id="audit-status">Loading...</p>
                        <div id="audit-list" class="grid-container"></div>
                    </div>
                </div>

                <div id="audit-modal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeAuditModal()">&times;</span>
                        <h2 id="modal-title">Album Details</h2>
                        <p id="modal-subtitle">Missing Tracks:</p>
                        <div id="modal-tracks" style="max-height: 300px; overflow-y: auto; text-align: left;"></div>
                        <div style="margin-top: 15px; text-align: right;">
                            <button onclick="queueSelectedTracks()">Queue Selected Tracks</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
                    <h3>Duplicates</h3>
                    <button onclick="loadDuplicates()">Check for Duplicates</button>
                    <div id="duplicates-container" style="margin-top: 10px; display: none;">
                        <p id="dupe-status">Loading...</p>
                        <div id="dupe-list"></div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2>Download & Sync</h2>
                <div class="actions">
                    <button onclick="triggerAction('/api/download', 'Processing Downloads...')">Process
                        Downloads</button>

                    <div class="sync-group">
                        <h3>Sync to iPod</h3>
                        <label>
                            Mode:
                            <select id="sync-mode">
                                <option value="playlists">Playlists Only</option>
                                <option value="library">Full Library</option>
                                <option value="selective">Selective (Artist)</option>
                            </select>
                        </label>
                        <label>
                            Format:
                            <select id="sync-format">
                                <option value="flac">FLAC</option>
                                <option value="mp3">MP3</option>
                                <option value="opus">Opus</option>
                                <option value="aac">AAC</option>
                            </select>
                        </label>
                        <button onclick="triggerSync()">Start Sync</button>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2>Logs / Output</h2>
                <div id="log-display">
                    Last Message: <span id="last-message">None</span>
                </div>
            </section>
        </main>
    </div>

    <script>
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('status-bar');
                    const msgSpan = document.getElementById('last-message');

                    statusDiv.textContent = `Status: ${data.message}`;
                    statusDiv.className = data.running ? 'status-running' : 'status-idle';
                    msgSpan.textContent = data.message;
                })
                .catch(err => console.error("Status poll failed", err));
        }

        function triggerAction(url, initialMsg) {
            // Optimistic update
            document.getElementById('status-bar').textContent = `Status: ${initialMsg}`;
            document.getElementById('status-bar').className = 'status-running';

            fetch(url, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert("Error: " + data.message);
                    }
                    updateStatus();
                });
        }

        function queuePlaylists() {
            const text = document.getElementById('playlist-urls').value;
            const urls = text.split('\n').filter(line => line.trim() !== '');

            if (urls.length === 0) {
                alert("Please enter at least one URL.");
                return;
            }

            document.getElementById('status-bar').textContent = `Status: Queueing ${urls.length} playlists...`;
            document.getElementById('status-bar').className = 'status-running';

            fetch('/api/playlists/queue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ urls: urls })
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert("Error: " + data.message);
                    }
                    updateStatus();
                });
        }

        function loadDuplicates() {
            const container = document.getElementById('duplicates-container');
            const list = document.getElementById('dupe-list');
            const status = document.getElementById('dupe-status');

            container.style.display = 'block';
            status.textContent = 'Searching for duplicates...';
            list.innerHTML = '';

            fetch('/api/duplicates')
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        status.textContent = 'Error: ' + data.message;
                        return;
                    }

                    const dupes = data.duplicates;
                    if (dupes.length === 0) {
                        status.textContent = 'No duplicates found!';
                        return;
                    }

                    status.textContent = `Found ${dupes.length} duplicate groups.`;

                    dupes.forEach(group => {
                        const div = document.createElement('div');
                        div.className = 'dupe-group';
                        div.style.marginBottom = '15px';
                        div.style.padding = '10px';
                        div.style.background = '#2a2a2a';
                        div.style.border = '1px solid #444';
                        div.style.borderRadius = '5px';

                        let html = `<strong>${group.artist} - ${group.title}</strong><br>`;
                        html += `<table style="width:100%; margin-top:5px; text-align:left;">`;

                        group.candidates.forEach((cand, idx) => {
                            const isRec = cand.is_recommended;
                            const color = isRec ? '#4caf50' : '#ff5252';
                            html += `
                                <tr>
                                    <td>
                                        <input type="radio" name="keep_${group.mbid}" value="${cand.path}" ${isRec ? 'checked' : ''} id="radio_${group.mbid}_${idx}">
                                    </td>
                                    <td><label for="radio_${group.mbid}_${idx}" style="color:${color}">${cand.path}</label></td>
                                    <td>Score: ${cand.score}</td>
                                </tr>
                            `;
                        });
                        html += `</table>`;
                        html += `<button onclick="resolveDuplicate('${group.mbid}')" style="margin-top:5px; padding: 3px 10px; font-size: 12px;">Resolve (Keep Selected)</button>`;
                        div.innerHTML = html;
                        list.appendChild(div);
                    });
                })
                .catch(err => status.textContent = 'Network error: ' + err);
        }

        function resolveDuplicate(mbid) {
            // Find selected radio
            const selected = document.querySelector(`input[name="keep_${mbid}"]:checked`);
            if (!selected) return;

            const keepPath = selected.value;

            // Gather all paths for this group (to find which to delete)
            // We can re-fetch or look at DOM. DOM is easier here.
            const allInputs = document.querySelectorAll(`input[name="keep_${mbid}"]`);
            const deletePaths = [];
            allInputs.forEach(input => {
                if (input.value !== keepPath) {
                    deletePaths.push(input.value);
                }
            });

            if (!confirm(`Keep:\n${keepPath}\n\nDelete ${deletePaths.length} others?`)) return;

            fetch('/api/duplicates/resolve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mbid: mbid,
                    keep_path: keepPath,
                    delete_paths: deletePaths
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Resolved!');
                        // Remove the UI element
                        const btn = selected.closest('.dupe-group');
                        if (btn) btn.remove();

                        // Update count
                        const remaining = document.querySelectorAll('.dupe-group').length;
                        document.getElementById('dupe-status').textContent = `Found ${remaining} duplicate groups.`;
                    } else {
                        alert('Error: ' + data.message);
                    }
                });
        }

        function triggerSync() {
            const mode = document.getElementById('sync-mode').value;
            const fmt = document.getElementById('sync-format').value;

            fetch('/api/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode, format: fmt })
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert("Error: " + data.message);
                    }
                    updateStatus();
                });
        }

        // --- Audit Logic ---
        function loadAuditResults() {
            const container = document.getElementById('audit-container');
            const list = document.getElementById('audit-list');
            const status = document.getElementById('audit-status');

            container.style.display = 'block';
            status.textContent = 'Searching for incomplete albums...';
            list.innerHTML = '';

            fetch('/api/audit/results')
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        status.textContent = 'Error: ' + data.message;
                        return;
                    }

                    const results = data.results;
                    if (results.length === 0) {
                        status.textContent = 'No incomplete albums found!';
                        return;
                    }

                    status.textContent = `Found ${results.length} incomplete albums.`;

                    // CSS for Grid
                    list.style.display = 'grid';
                    list.style.gridTemplateColumns = 'repeat(auto-fill, minmax(150px, 1fr))';
                    list.style.gap = '15px';

                    results.forEach((item, idx) => {
                        const div = document.createElement('div');
                        div.className = 'album-card';
                        div.style.background = '#2a2a2a';
                        div.style.padding = '10px';
                        div.style.borderRadius = '5px';
                        div.style.textAlign = 'center';
                        div.style.cursor = 'pointer';

                        // Fallback image handling
                        div.onclick = () => showAuditDetails(item.mbid);

                        div.innerHTML = `
                            <img src="${item.cover_art}" alt="Cover" style="width:100%; height:auto; border-radius:4px; aspect-ratio:1/1; object-fit:cover;" onerror="this.src='https://via.placeholder.com/150?text=No+Cover'">
                            <div style="margin-top:5px; font-weight:bold; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.album}</div>
                            <div style="font-size:12px; color:#aaa; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.artist}</div>
                            <div style="font-size:12px; color:#f44336; margin-top:2px;">Missing: ${item.missing}</div>
                        `;
                        list.appendChild(div);
                    });
                })
                .catch(err => status.textContent = 'Network error: ' + err);
        }

        // Store current audit details globally for queueing
        let currentAuditDetails = null;

        function showAuditDetails(mbid) {
            const modal = document.getElementById('audit-modal');
            const tracksDiv = document.getElementById('modal-tracks');
            const title = document.getElementById('modal-title');
            const subtitle = document.getElementById('modal-subtitle');

            modal.style.display = 'block';
            title.textContent = "Loading...";

            fetch(`/api/audit/details?mbid=${mbid}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        title.textContent = "Error";
                        tracksDiv.textContent = data.message;
                        return;
                    }

                    const info = data.data;
                    currentAuditDetails = info;

                    title.textContent = info.album;
                    subtitle.textContent = `${info.artist} - Missing ${info.missing_count}/${info.total_tracks}`;

                    let html = '<table style="width:100%; border-collapse: collapse;">';

                    info.missing_tracks.forEach((t, idx) => {
                        // CHECKED by default as requested
                        html += `
                        <tr style="border-bottom:1px solid #444;">
                            <td style="padding:8px; width:30px;">
                                <input type="checkbox" id="chk_track_${idx}" checked data-idx="${idx}">
                            </td>
                            <td style="padding:8px;">${t.disc}-${t.track}</td>
                            <td style="padding:8px;">${t.title}</td>
                        </tr>
                       `;
                    });
                    html += '</table>';
                    tracksDiv.innerHTML = html;
                });
        }

        function closeAuditModal() {
            document.getElementById('audit-modal').style.display = 'none';
        }

        function queueSelectedTracks() {
            if (!currentAuditDetails) return;

            const checks = document.querySelectorAll('#modal-tracks input[type="checkbox"]:checked');
            if (checks.length === 0) {
                alert("No tracks selected.");
                return;
            }

            const selectedItems = [];
            checks.forEach(chk => {
                const idx = chk.getAttribute('data-idx');
                const track = currentAuditDetails.missing_tracks[idx];
                selectedItems.push({
                    artist: currentAuditDetails.artist,
                    title: track.title
                });
            });

            // Check if ALL are selected (heuristic for full album queue, though user flow is explicit)
            // But user said "I will only want to complete specific albums though". 
            // If they modify selection, we queue specific tracks. 
            // If they select all, we can queue individual tracks (safer) OR full album query if we trust it.
            // For now, simple list.

            const btn = document.querySelector('#audit-modal button');
            const originalText = btn.textContent;
            btn.textContent = "Queueing...";
            btn.disabled = true;

            fetch('/api/audit/queue', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: selectedItems,
                    album_info: {
                        artist: currentAuditDetails.artist,
                        album: currentAuditDetails.album
                    }
                })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`Queued ${data.queued_count} tracks.`);
                        closeAuditModal();
                    } else {
                        alert("Error: " + data.message);
                    }
                })
                .finally(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }

        // Poll status every 2 seconds
        setInterval(updateStatus, 2000);
        updateStatus();
    </script>
</body>

</html>